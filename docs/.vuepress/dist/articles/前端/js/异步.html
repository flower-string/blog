<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步 | CHAO BLOG</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="this is a blog build by vuepress">
    
    <link rel="preload" href="/assets/css/0.styles.d3d7476b.css" as="style"><link rel="preload" href="/assets/js/app.f97d11e0.js" as="script"><link rel="preload" href="/assets/js/2.c4a55d75.js" as="script"><link rel="preload" href="/assets/js/19.48135194.js" as="script"><link rel="prefetch" href="/assets/js/10.cd830b02.js"><link rel="prefetch" href="/assets/js/11.7c4cbfc9.js"><link rel="prefetch" href="/assets/js/12.2fc5ef62.js"><link rel="prefetch" href="/assets/js/13.35b2e41a.js"><link rel="prefetch" href="/assets/js/14.15d3b615.js"><link rel="prefetch" href="/assets/js/15.3b004cd7.js"><link rel="prefetch" href="/assets/js/16.ef0b6eaf.js"><link rel="prefetch" href="/assets/js/17.516ad126.js"><link rel="prefetch" href="/assets/js/18.a14128ad.js"><link rel="prefetch" href="/assets/js/20.f53e3b63.js"><link rel="prefetch" href="/assets/js/21.ec6e36d2.js"><link rel="prefetch" href="/assets/js/22.e7715ba2.js"><link rel="prefetch" href="/assets/js/23.e0693374.js"><link rel="prefetch" href="/assets/js/24.a36116e9.js"><link rel="prefetch" href="/assets/js/25.634dca41.js"><link rel="prefetch" href="/assets/js/26.b9622f5c.js"><link rel="prefetch" href="/assets/js/27.eb49a96a.js"><link rel="prefetch" href="/assets/js/28.84d60169.js"><link rel="prefetch" href="/assets/js/29.53bf131a.js"><link rel="prefetch" href="/assets/js/3.0ec01e5e.js"><link rel="prefetch" href="/assets/js/30.1331a972.js"><link rel="prefetch" href="/assets/js/31.ac0a72dd.js"><link rel="prefetch" href="/assets/js/4.2176f0d8.js"><link rel="prefetch" href="/assets/js/5.91c18d5d.js"><link rel="prefetch" href="/assets/js/6.537e369f.js"><link rel="prefetch" href="/assets/js/7.426639d5.js"><link rel="prefetch" href="/assets/js/8.32bf23b4.js"><link rel="prefetch" href="/assets/js/9.dc91dd0d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d3d7476b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CHAO BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章分类" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章分类" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/articles/前端/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/articles/前端/js/" class="nav-link">
  js
</a></li><li class="dropdown-subitem"><a href="/articles/前端/Vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/articles/前端/React/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/articles/前端/library/" class="nav-link">
  工具库
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/articles/设计/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/articles/后端/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/articles/编程通用/" class="nav-link">
  编程通用
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章分类" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章分类" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/articles/前端/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/articles/前端/js/" class="nav-link">
  js
</a></li><li class="dropdown-subitem"><a href="/articles/前端/Vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/articles/前端/React/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/articles/前端/library/" class="nav-link">
  工具库
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/articles/设计/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/articles/后端/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/articles/编程通用/" class="nav-link">
  编程通用
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/articles/前端/js/常用高阶函数.html" class="sidebar-link">常用高阶函数</a></li><li><a href="/articles/前端/js/面向对象.html" class="sidebar-link">面向对象</a></li><li><a href="/articles/前端/js/异步.html" class="active sidebar-link">异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#异步编程" class="sidebar-link">异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#什么是异步编程" class="sidebar-link">什么是异步编程</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#异步执行机制" class="sidebar-link">异步执行机制</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#回调地狱" class="sidebar-link">回调地狱</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#promise" class="sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#promise基础" class="sidebar-link">promise基础</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#实例方法" class="sidebar-link">实例方法</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#promise连锁和合成" class="sidebar-link">promise连锁和合成</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#异步函数" class="sidebar-link">异步函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#async修饰符" class="sidebar-link">async修饰符</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#await关键字" class="sidebar-link">await关键字</a></li><li class="sidebar-sub-header"><a href="/articles/前端/js/异步.html#异步函数的策略" class="sidebar-link">异步函数的策略</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h1> <h2 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h2> <h3 id="什么是异步编程"><a href="#什么是异步编程" class="header-anchor">#</a> 什么是异步编程</h3> <p>与其他函数并行执行的函数称为异步。可以用下面的图简单理解。</p> <p><img src="https://img-blog.csdnimg.cn/e91e8d3cb9d048d0ab88da6297109a1f.png" alt="请添加图片描述"></p> <h3 id="异步执行机制"><a href="#异步执行机制" class="header-anchor">#</a> 异步执行机制</h3> <p>当遇到需要等待的异步函数时，浏览器会将异步函数放入异步队列中，在异步操作完成后将其放回主线程。</p> <p><img src="https://img-blog.csdnimg.cn/e1e679463f6a48c4871de4c37023cd0e.png" alt="请添加图片描述"></p> <h3 id="回调地狱"><a href="#回调地狱" class="header-anchor">#</a> 回调地狱</h3> <p>以往的异步实现是采用回调函数的方法。</p> <p>当需要嵌套回调时，会导致代码十分复杂，简称回调地狱。</p> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <h3 id="promise基础"><a href="#promise基础" class="header-anchor">#</a> promise基础</h3> <p>promise是es6中新增的对象，通过new来实例化。</p> <p>在new时需要传入一个函数作为参数，这个函数被称为<strong>执行器</strong>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/ed689f0138bf4a16853bbcc8f25d6d6b.png" alt="请添加图片描述"></p> <p>会得到这样一个对象。</p> <h4 id="状态机"><a href="#状态机" class="header-anchor">#</a> 状态机</h4> <p>promise是一个有状态的对象。他拥有以下的三种状态。</p> <ul><li>待定（pending）</li> <li>兑现（fulfilled），也叫做解决（resolved）</li> <li>拒绝（reject）</li></ul> <p>待定是promise的初始状态，在待定状态下，promise可能变为兑现或拒绝，也可能已知处于待定状态。</p> <p>promise的状态时是不可逆的，当她由待定变为兑现或者拒绝之后就不会再发生变化。</p> <p>promise的状态是私有的，不能被直接访问。</p> <h4 id="解决值和拒绝理由"><a href="#解决值和拒绝理由" class="header-anchor">#</a> 解决值和拒绝理由</h4> <p>promise有两种用途，一种是提供状态，另一种是根据状态返回不用的值。</p> <ul><li>当promise处于待定状态时，有一个内部值为undefined。</li> <li>当promise处于兑现状态时，promise的内部值会变为<strong>resolve</strong>函数的参数，也就是解决值。</li> <li>当promise处于拒绝状态时，pormise的内部值会变为<strong>reject</strong>函数的参数，也就是拒绝的理由。</li></ul> <h4 id="状态控制"><a href="#状态控制" class="header-anchor">#</a> 状态控制</h4> <p>通过reject和resolve方法可以控制promsie的状态。</p> <p>resolve和reject会作为<strong>执行器</strong>函数的参数，执行器函数内的语句是同步执行的。</p> <p>当执行器函数内调用resolve时，promise的状态会变为兑现。</p> <p>当执行器函数内调用reject时，promise 的状态会变为拒绝。</p> <p>因为promise的状态不可逆，所以当两个状态控制函数执行其中一个后，其他的会立刻失效。</p> <h4 id="resolve"><a href="#resolve" class="header-anchor">#</a> resolve</h4> <p>promsie的初始状态并不是必须为待定。</p> <p>通过下面的语句可以创建一个初始状态为兑现的promsie对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve <span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;这里是一坨数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这两段函数是完全等价的，resolve的参数会作为promise的内部值，多余的参数会被忽略。</p> <p><img src="https://img-blog.csdnimg.cn/789de8de46324306a4c7d33170ed83d3.png" alt="请添加图片描述"></p> <h4 id="reject"><a href="#reject" class="header-anchor">#</a> reject</h4> <p>与resolve相同，promise的初始状态也可以是拒绝。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> p <span class="token operator">=</span> Promsie<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;就是不想接受&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/5e764e5d69b14a1e9d0acc0a61771bca.png" alt="请添加图片描述"></p> <p>与resolve不同的是，resolve传入promise作为参数会形成空包装，而reject传入promise依然会是拒绝的理由。</p> <h3 id="实例方法"><a href="#实例方法" class="header-anchor">#</a> 实例方法</h3> <h4 id="thenable接口"><a href="#thenable接口" class="header-anchor">#</a> Thenable接口</h4> <p>在所有的js异步对象中都有一个<strong>then</strong>方法，这个<strong>then</strong>方法被认为是实现了Thenable接口</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Thenable</span> <span class="token punctuation">{</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>promise就实现了thenable接口，在后面的<strong>async/await</strong>部分会用到这个接口。</p> <h4 id="then方法"><a href="#then方法" class="header-anchor">#</a> then方法</h4> <p>then方法可以接受两个函数作为参数
第一个参数在promise状态变为满足时执行，第二个在promise状态变为拒绝是执行，非函数参数会被忽略。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">onres</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">onreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>无论执行哪一个方法，都会返回一个包装过的Promise对象。</li> <li>除非返回拒绝的promise对象，或者是抛出错误，否则都会返回满足状态的promsie对象。</li> <li>promise对象的值就是函数的返回值，如果没有返回值则包装undefined</li></ul> <h4 id="catch方法"><a href="#catch方法" class="header-anchor">#</a> catch方法</h4> <p>catch方法本质上是then方法的一个语法糖，可以用来处理拒绝状态的promise。
他只接受一个函数作为参数，其他行为与then方法相同。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promsie</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="finally方法"><a href="#finally方法" class="header-anchor">#</a> finally方法</h4> <ul><li>只要promise的状态发生变化，finally方法就会被执行，这个函数主要用来处理then和catch中的重复的代码。</li> <li>因为finally方法与状态无关，所以返回的promise对象是父对象的传递。</li></ul> <h4 id="非重入方法"><a href="#非重入方法" class="header-anchor">#</a> 非重入方法</h4> <p>上面介绍的三个方法都是非重入方法。
当promise 的状态发生变化时，相应的处理程序会被推入异步队列，在当前线程的程序全部执行完毕后，开始执行异步队列中的程序。
<img src="https://img-blog.csdnimg.cn/b14d99e8bad04d2785fe8821a1a1aaaf.png" alt="在这里插入图片描述"></p> <h4 id="值传递"><a href="#值传递" class="header-anchor">#</a> 值传递</h4> <p>promise在执行相应的处理程序时可以进行传值。
在执行器函数中传入的两个函数可以在调用时接受参数，这个参数会传递到对用的处理程序中作为内部值或者拒绝理由。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span>req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">res</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 111</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="临近执行顺序"><a href="#临近执行顺序" class="header-anchor">#</a> 临近执行顺序</h4> <p>如果为promise添加了多个处理程序，当promise状态变化时，相应的处理程序会依次执行，无论是then，catch或者是finally。</p> <h3 id="promise连锁和合成"><a href="#promise连锁和合成" class="header-anchor">#</a> promise连锁和合成</h3> <h4 id="连锁"><a href="#连锁" class="header-anchor">#</a> 连锁</h4> <p>多个promise进行组合可以形成强大的逻辑，连锁就是将多个promise一个接一个的连接起来，形成一条链。</p> <p>这种编程可以完美的解决之前的回调地狱问题。</p> <p>比如之前的回调地狱的写法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str <span class="token punctuation">,</span> callback <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">dealy</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p3&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p4&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>就可以改写为</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve <span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve <span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p3&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">&quot;p4&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre></div><h4 id="期约合成"><a href="#期约合成" class="header-anchor">#</a> 期约合成</h4> <p>将多个promise合成一个称为期约合成。Promise提供了两个静态方法用于期约合成。</p> <ol><li>all方法
<ul><li>all方法接受一个数组。</li> <li>如果所有的	期约都被解决，则合成的期约的解决值就是所有期约解决值组成的数组。</li> <li>如果有期约拒绝，则合成的期约的值为第一个拒绝的理由，其他拒绝的期约也会被隐式处理。</li></ul></li> <li>race方法
race方法同样接受一个数组，他是一组期约中最先解决的期约的镜像。他会包装第一个落定的期约。</li></ol> <h2 id="异步函数"><a href="#异步函数" class="header-anchor">#</a> 异步函数</h2> <h3 id="async修饰符"><a href="#async修饰符" class="header-anchor">#</a> async修饰符</h3> <p>为函数添加async修饰符可以将其变为异步函数，但是其内部的代码依然是同步执行的，async只是一个修饰符，本身对函数没有任何影响。</p> <p>异步函数的返回值会被<strong>promise.resolve</strong>包装</p> <h3 id="await关键字"><a href="#await关键字" class="header-anchor">#</a> await关键字</h3> <p>await关键字可以用在异步函数中，用于暂停异步函数的执行，然后将后面的语句包装进promise推入异步队列。</p> <p><img src="https://img-blog.csdnimg.cn/78b5f1066e0e4b7cbf4d8e5834903ca8.png" alt="在这里插入图片描述"></p> <p>注意await关键字只能用在异步函数中。</p> <h3 id="异步函数的策略"><a href="#异步函数的策略" class="header-anchor">#</a> 异步函数的策略</h3> <h4 id="sleep函数"><a href="#sleep函数" class="header-anchor">#</a> sleep函数</h4> <p>利用await可以实现java中的sleep函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> t0 <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//等待1500毫秒</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="平行执行"><a href="#平行执行" class="header-anchor">#</a> 平行执行</h4> <p>如果多条语句的顺序不是必须的，那么可以先一次性初始化出所有的期约，然后使用await全部推入异步队列，先解决的期约先执行。可以减少等待的时间。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> delay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span>comsole<span class="token punctuation">.</span>log <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> finished</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> t0 <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> p4 <span class="token operator">=</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">await</span> p0<span class="token punctuation">;</span>
	<span class="token keyword">await</span> p1<span class="token punctuation">;</span>
	<span class="token keyword">await</span> p2<span class="token punctuation">;</span>
	<span class="token keyword">await</span> p3<span class="token punctuation">;</span>
	<span class="token keyword">await</span> p4<span class="token punctuation">;</span>

	<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t0<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms elapsed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//5个promise 的执行顺序是随机的。</span>
</code></pre></div><h4 id="期约串联"><a href="#期约串联" class="header-anchor">#</a> 期约串联</h4> <p>使用await关键字，使得promise 的链式编程更加简洁。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">addTwo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token function">addThree</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token function">addFive</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addTen</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token punctuation">[</span>addTwo <span class="token punctuation">,</span> addThree <span class="token punctuation">,</span> addFive<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		x <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">addTen</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token comment">//  19</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/前端/js/面向对象.html" class="prev">
        面向对象
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f97d11e0.js" defer></script><script src="/assets/js/2.c4a55d75.js" defer></script><script src="/assets/js/19.48135194.js" defer></script>
  </body>
</html>
